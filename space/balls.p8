pico-8 cartridge // http://www.pico-8.com
version 42
__lua__

local ball = {}

ball.__index = ball

function ball.new(x,y,color,speed,angle)
	local newball = {
		x = x,
		y = y,
		color = color or 9,
		angle = angle,
		speed = speed
	}

	setmetatable(newball, ball)	
	return newball
end

function ball:move()
	local vx = cos(self.angle) * self.speed
	local vy = sin(self.angle) * self.speed
	
	self.x = self.x + vx
	self.y = self.y + vy
	
	if self.x >= 120 then
		self.x = 119
		self.angle = 0.5 - self.angle
	end
	
	if self.x <= 0 then
		self.x = 1
		self.angle = 0.5 - self.angle
	end
	
	if self.y >= 120 then
		self.y = 119
		self.angle = -self.angle
	end
	
	if self.y <= 0 then
		self.y = 1
		self.angle = -self.angle
	end
	
	self.angle = self.angle % 1
end

-- function ball:detect_collision(other_ball)
-- 	local dx = self.x - other_ball.x
-- 	local dy = self.y - other_ball.y
-- 	local distance = sqrt(dx * dx + dy * dy)

-- 	if distance < 8 then 
-- 		printh(distance) 
-- 		sfx(1)
-- 	end
-- end

function ball:detect_collision(other_ball)
	local dx = self.x - other_ball.x
	local dy = self.y - other_ball.y
	local distance = sqrt(dx * dx + dy * dy)
	
	if distance < 8 then
	--   sfx(1)
	  
	  -- normalize collision vector
	  local nx = dx / distance
	  local ny = dy / distance
	  
	  -- convert angles to velocity components
	  local v1x = cos(self.angle) * self.speed
	  local v1y = sin(self.angle) * self.speed
	  local v2x = cos(other_ball.angle) * other_ball.speed
	  local v2y = sin(other_ball.angle) * other_ball.speed
	  
	  -- relative velocity in collision normal direction
	  local dvn = (v1x - v2x) * nx + (v1y - v2y) * ny
	  
	  -- don't resolve if velocities are separating
	  if dvn > 0 then
		return
	  end
	  
	  -- calculate new velocities (assuming equal mass)
	  local new_v1x = v1x - dvn * nx
	  local new_v1y = v1y - dvn * ny
	  local new_v2x = v2x + dvn * nx
	  local new_v2y = v2y + dvn * ny
	  
	  -- convert back to angle and speed
	  self.speed = sqrt(new_v1x * new_v1x + new_v1y * new_v1y)
	  self.angle = atan2(new_v1y, new_v1x)
	  
	  other_ball.speed = sqrt(new_v2x * new_v2x + new_v2y * new_v2y)
	  other_ball.angle = atan2(new_v2y, new_v2x)
	  
	  -- separate balls to prevent overlap
	  local overlap = 8 - distance
	  local sep_x = nx * overlap * 0.8
	  local sep_y = ny * overlap * 0.8
	  
	  self.x += sep_x
	  self.y += sep_y
	  other_ball.x -= sep_x
	  other_ball.y -= sep_y
	end
  end

local balls = {}

function _init()
	cls()
	for i = 1,50,1 do
		local color = flr(rnd(15)) + 1
		local x = flr(rnd(111)) + 8
		local y = flr(rnd(111)) + 8
		local speed = rnd(3) + 0.1
		local angle = rnd(1)
		add(
			balls, 
			ball.new(x,y,color,speed,angle)
		)
	end
end

function _update()
	for index, ball in pairs(balls) do
		ball:move()
	end
	
	for index, ball in pairs(balls) do
		for i = index + 1, #balls, 1 do
			ball:detect_collision(balls[i])
		end
	end
end

function _draw()
	cls()
	for index, ball in pairs(balls) do
		pal(9, ball.color)
		spr(1,ball.x, ball.y)
		pal()
	end
end
__gfx__
00000000004444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000049999400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700499999940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000499999940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000499999940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700499999940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000049999400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0000000038750377503675035750357500c06021850218402183020820208502084720867208772185021810218202733006030248202282021820208571e8201d8551c8251a8251985510b173275030b762cb16
000100001b3701c3501d3501c3501b3601a360183601636013350103400d3400733006330043500135001350023500235001350013500035000350003002a2002820024200212001e2001820015200132000c200
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002000001885000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
04 01424344

